<!DOCTYPE html>
<html lang="en">
<head>
  <title>Host Virtual BINGO</title>
  <meta charset="utf-8">
  <meta name="description" content="Host a virtual BINGO game, Randomly draw numbers, Check for BINGO winners">
  <meta name="keywords" content="bingo, virtual, online, generate, cards, boards, draw, random">
  <meta name="author" content="Phil Perilstein">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="js/common.js"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
<style>
table {
  width: "100%";
  table-layout: fixed;
}
.bingo td {
  text-align: center;
  vertical-align: center;
  font-size: 12px;
}
td.header {
  font-size: 20px;
}
.winnerTable {
  table-layout: fixed;
  text-align: center;
  width: 100%;
  border: 3px solid black;
}

.winnerTable td {
  width: 20%;
  position: relative;
  border: 1px solid black;
}
.winnerTable td:after {
  content: '';
  display: block;
  margin-top: 100%;
}
td .content {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
td.selected {
  background-color: #218F02;
  color: white;
} 
body {
  background-color: #9d9d9d;
  color: #222222;
}
.navbar-custom {
  border-radius: 0px;
}
.navbar-custom a:hover {
    color: #ffd449 !important;
  }
.navbar-brand {
  padding: 0px; /* firefox bug fix */
}
.navbar-brand>img {
  height: 100%;
  padding: 15px; /* firefox bug fix */
  width: auto;
}
.progress-bar-custom {
  background-color: #ffd449 !important;
  color: #000000;
}
.latestPick {
  transition: background-color 1s;
}
.highlightLatestPick {
  transition: background-color 1s;
  background-color: #ffd449;
}
</style>
</head>
<body>

  <nav id="navbar" class="navbar navbar-inverse navbar-custom navbar-fixed-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>                        
        </button>
          <a class="navbar-brand" href="/"><img src="images/logo1.png" /></a>
      </div>
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav">
          <li><a href="setup.html">Generate cards</a></li>
          <li class="active"><a href="admin.html">Host game</a></li>
          <li><a href="faq.html">FAQs</a></li>
          <li><a href="donate.html">Donate</a></li>
          <li><a href="rules.html">Rules</a></li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container-fluid" style="margin-top: 50px;">
  <div class="page-header">

    <div class="row">
        <div class="col-sm-4">
          <div style="width: 100%;">
            <div style="max-width: 50%; margin-left: 0; margin-right: auto;">
              <a href="/" title="home"><img src="images/logo1.png" class="img-responsive" /></a>
              <p style="font-size: 20px">Admin Console</p>
            </div>
          </div>
        </div>
        <div class="col-sm-8">
          <form action="#" onsubmit="return false;">
            <div class="input-group">
                <span class="input-group-addon">Check Winner</span>
                <input type="text" class="form-control" maxlength="3" autocomplete="off" id="cardNumber" placeholder="Card Number">
                <div class="input-group-btn">
                    <button class="btn btn-default" id="check-winner" type="submit">
                        <i class="glyphicon glyphicon-search"></i>
                    </button>
                </div>
            </div>
          </form>
        </div>
    </div>

  </div><!-- End page-header -->

  <main>
    <div style="background-color: white">
      <table class="table-striped table-bordered bingo" style="width: 100%">
      <tr><td class="header">B</td><td id="B1"></td><td id="B2"></td><td id="B3"></td><td id="B4"></td><td id="B5"></td><td id="B6"></td><td id="B7"></td><td id="B8"></td><td id="B9"></td><td id="B10"></td><td id="B11"></td><td id="B12"></td><td id="B13"></td><td id="B14"></td><td id="B15"></td></tr>
      <tr><td class="header">I</td><td id="I16"></td><td id="I17"></td><td id="I18"></td><td id="I19"></td><td id="I20"></td><td id="I21"></td><td id="I22"></td><td id="I23"></td><td id="I24"></td><td id="I25"></td><td id="I26"></td><td id="I27"></td><td id="I28"></td><td id="I29"></td><td id="I30"></td></tr>
      <tr><td class="header">N</td><td id="N31"></td><td id="N32"></td><td id="N33"></td><td id="N34"></td><td id="N35"></td><td id="N36"></td><td id="N37"></td><td id="N38"></td><td id="N39"></td><td id="N40"></td><td id="N41"></td><td id="N42"></td><td id="N43"></td><td id="N44"></td><td id="N45"></td></tr>
      <tr><td class="header">G</td><td id="G46"></td><td id="G47"></td><td id="G48"></td><td id="G49"></td><td id="G50"></td><td id="G51"></td><td id="G52"></td><td id="G53"></td><td id="G54"></td><td id="G55"></td><td id="G56"></td><td id="G57"></td><td id="G58"></td><td id="G59"></td><td id="G60"></td></tr>
      <tr><td class="header">O</td><td id="O61"></td><td id="O62"></td><td id="O63"></td><td id="O64"></td><td id="O65"></td><td id="O66"></td><td id="O67"></td><td id="O68"></td><td id="O69"></td><td id="O70"></td><td id="O71"></td><td id="O72"></td><td id="O73"></td><td id="O74"></td><td id="O75"></td></tr>
      </table>
    </div>
    <hr />

    <!-- Progress Bar -->
    <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-custom" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
            0%
        </div>
    </div>


    <div class="row">
        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">Admin actions</div>
                <div class="panel-body">
                    <button class="btn btn-default" id="pick-number">Pick Number</button>
                    <button class="btn btn-default" id="new-game">New Game</button>
                </div>
            </div>
        </div>
        <div class="col-sm-8">
            <div class="panel panel-default">
                <div class="panel-heading">Picked numbers</div>
                <div class="panel-body" id="orderPicked"></div>
            </div>
        </div>
    </div>

  </main>
</div><!-- End Container -->

<script type="text/javascript">
let drawnNumbers = new Set();
let csvNumbers = getCookie("drawnNumbers");
if (csvNumbers) {
  let arrNumbers = csvNumbers.split(',');
  if (arrNumbers && arrNumbers.length > 0) {
    drawnNumbers = new Set(arrNumbers);
    for (let i=0; i< arrNumbers.length; i++) {
      let num = arrNumbers[i];
      updateOnDraw(num, i+1);
    }   
  }  
}

if (drawnNumbers.size >= 75) {
    let pickNumButton = document.getElementById("pick-number");
    pickNumButton.className = "btn btn-default disabled";
  }

function getBingoNumber(num) {
  let letter = '';
  if (1 <= num && num <= 15) {
      letter = 'B';
  }
  else if (16 <= num && num <= 30) {
      letter = "I";
  }
  else if (31 <= num && num <= 45) {
      letter = "N";
  }
  else if (46 <= num && num <= 60) {
      letter = "G";
  }
  else if (61 <= num && num <=75) {
      letter = "O";
  }
  return letter + num;
}

function drawNumber() {
  let num = Math.floor(Math.random() * (75 - 1 + 1) + 1);
  let bingoNum = getBingoNumber(num);

  while (drawnNumbers.has(bingoNum)) {
    num = Math.floor(Math.random() * (75 - 1 + 1) + 1);
    bingoNum = getBingoNumber(num);
  }

  drawnNumbers.add(bingoNum);
  setCookie("drawnNumbers", Array.from(drawnNumbers).join(','), 30);


  return bingoNum;
}

function clearLatestPick() {
  let latestPick = document.getElementsByClassName('latestPick');
  for (let block of latestPick) {
    block.classList.remove('latestPick');
  }
}

async function updateOnDraw(num, size, annimate) {
    clearLatestPick();
    document.getElementById(num).textContent = num;
    document.getElementById("orderPicked").innerHTML = `Pick[${size}] ${num}<br />` + document.getElementById("orderPicked").innerHTML;
    let percentComplete = (drawnNumbers.size / 75 * 100).toFixed(2);
    let progressBar = document.getElementsByClassName("progress-bar")[0];
    progressBar.textContent = `${percentComplete}%`;
    progressBar.style = `width:${percentComplete}%`;
    if (annimate) {
      document.getElementById(num).classList.add('highlightLatestPick');
      await sleep(1000);
      document.getElementById(num).classList.add('latestPick');
      document.getElementById(num).classList.remove('highlightLatestPick');
    }
}

function processNewGame() {
  deleteCookie("drawnNumbers");
  drawnNumbers = new Set();
  for (let i=1; i<=75; i++) {
    document.getElementById(getBingoNumber(i)).textContent = '';
  }
  clearLatestPick();
  document.getElementById("orderPicked").innerHTML = '';
  let progressBar = document.getElementsByClassName("progress-bar")[0];
  progressBar.textContent = "0%";
  progressBar.style = "width:0%";
  let pickNumButton = document.getElementById("pick-number");
  pickNumButton.className = "btn btn-default";
}

/* ##########################
 * # Create Event Listeners #
 * ##########################
 */ 
document.getElementById("pick-number").addEventListener("click", async function(event) {
  if (drawnNumbers.size < 75) {
    let num = drawNumber();
    await updateOnDraw(num, drawnNumbers.size, true); 
  }
  
  if (drawnNumbers.size >= 75) {
    let pickNumButton = document.getElementById("pick-number");
    pickNumButton.className = "btn btn-default disabled";
  }
});

document.getElementById("new-game").addEventListener("click", function(event) {
  let header = `<h2 class="text-warning">Warning <span class="glyphicon glyphicon-warning-sign"></span></h2>
          <p>Are you sure you want to start a new game?  Previously selected numbers will be discarded.</p>`;
  let footer = `<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" onclick="processNewGame()" class="btn btn-default" data-dismiss="modal">Yes</button>`;
  alert(header, undefined, footer);
});

document.getElementById("check-winner").addEventListener("click", function(event) {
	let cardNumber = document.getElementById("cardNumber").value;
  if (cardNumber.length < 3) {
    cardNumber = cardNumber.padStart(3,'0');
  }
  if (cardNumber === "000" || isNaN(cardNumber) || cardNumber.includes('.')) {
    alert('<h2 class="text-danger">Error <span class="glyphicon glyphicon-exclamation-sign"></span></h2>', `<div class="alert alert-danger">Invalid Card Number</div>`);
    return;
  }
	loadDoc(`card_data/bingo-${cardNumber}.json`, function(jsonFile) {
  		let bingoCard = JSON.parse(jsonFile.response);
        checkWinner(bingoCard, cardNumber);
    });
});

function generateVisual(bingoCard) {
  let cardTable = document.createElement("TABLE");
  cardTable.className = "winnerTable";
  let headerRow = document.createElement("TR");
  let BINGO = ['B','I','N','G','O'];
  for (let letter of BINGO) {
      let td = document.createElement("TD");
      td.innerHTML = `<div class="content"><span style="font-size: 4vw; font-weight:bold;">${letter}</span></div>`;
      headerRow.appendChild(td);
  }
  cardTable.appendChild(headerRow);

  let i = 0;
  for (let row = 0; row < bingoCard.length; row++) {
    let tr = document.createElement("TR");
    for (let column = 0; column < bingoCard[row].length; column++) {
      let bingoNumber = getBingoNumber(bingoCard[row][column]);
      let td = document.createElement("TD");
      if (drawnNumbers.has(bingoNumber) || bingoNumber === 'FREE SPACE') {
        td.classList.add("selected");
      }
      td.innerHTML = `<div class="content"><span style="font-size: 2vw";>${bingoNumber}</span></div>`;
      tr.appendChild(td);
      i++;
    }
    cardTable.appendChild(tr);
  }
  return cardTable;
}

function checkWinner(bingoCard, cardNumber) {
    let matchPos = [];
    for (let row = 0; row < bingoCard.length; row++) {
        for (let column = 0; column < bingoCard[row].length; column++) {
            let bingoNumber = getBingoNumber(bingoCard[row][column]);
            if (drawnNumbers.has(bingoNumber) || bingoNumber === 'FREE SPACE') {
                matchPos.push({row, column});
            }
        }
    }

    let row1Match = matchPos.filter(m => m.row === 0);
    let row2Match = matchPos.filter(m => m.row === 1);
    let row3Match = matchPos.filter(m => m.row === 2);
    let row4Match = matchPos.filter(m => m.row === 3);
    let row5Match = matchPos.filter(m => m.row === 4);

    let bMatches = matchPos.filter(m => m.column === 0);
    let iMatches = matchPos.filter(m => m.column === 1);
    let nMatches = matchPos.filter(m => m.column === 2);
    let gMatches = matchPos.filter(m => m.column === 3);
    let oMatches = matchPos.filter(m => m.column === 4);

    let diagonal1 = matchPos.filter(m => (m.row === m.column));
    let diagonal2 = matchPos.filter(m => (m.row + m.column === 4));

    let fourCorners = matchPos.filter(m => (m.row === 0 || m.row === 4) && (m.column === 0 || m.column === 4));
   

    let retVal = [];
    if (bMatches && bMatches.length === 5) {
        retVal.push('Vertical BINGO on B');
    }
    if (iMatches && iMatches.length === 5) {
        retVal.push('Vertical BINGO on I');
    }
	if (nMatches && nMatches.length === 5) {
        retVal.push('Vertical BINGO on N');
    }
	if (gMatches && gMatches.length === 5) {
        retVal.push('Vertical BINGO on G');
    }
	if (oMatches && oMatches.length === 5) {
        retVal.push('Vertical BINGO on O');
    }
    if (row1Match && row1Match.length === 5) {
        retVal.push('Horizontal BINGO on Row-1');
    }
    if (row2Match && row2Match.length === 5) {
        retVal.push('Horizontal BINGO on Row-2');
    }
    if (row3Match && row3Match.length === 5) {
        retVal.push('Horizontal BINGO on Row-3');
                    }
    if (row4Match && row4Match.length === 5) {
        retVal.push('Horizontal BINGO on Row-4');
    }
    if (row5Match && row5Match.length === 5) {
        retVal.push('Horizontal BINGO on Row-5');
    }

    if (row3Match && row3Match.length === 5 && 
    bMatches && bMatches.length === 5 &&
    oMatches && oMatches.length === 5) {
      retVal.push('Letter H BINGO');
    }

    if (diagonal1 && diagonal1.length === 5 &&
      diagonal2 && diagonal2.length === 5) {
        retVal.push('Letter X BINGO');
      }

    if (fourCorners && fourCorners.length === 4) {
        retVal.push('4 Corners BINGO');
    }
    if (diagonal1 && diagonal1.length === 5) {
        retVal.push('Diagonal BINGO Top Left to Bottom Right');
    }
    if (diagonal2 && diagonal2.length === 5) {
        retVal.push('Diagonal BINGO Bottom Left to Top Right');
    }
    if (matchPos && matchPos.length === 25) {
        retVal.push('BLACK OUT BINGO');
    }
  
    let winnerInfo = ''; 
    if (retVal.length > 0) {
      winnerInfo = '<div class="alert alert-success">';
        for (let str of retVal) {
            winnerInfo += str + '<br />'; 
        }
        winnerInfo += '</div>';
    }
    else {
        winnerInfo = '<div class="alert alert-danger">Not a BINGO</div>';
    } 

    let table = generateVisual(bingoCard);
    let playerName = getPlayerName(cardNumber);
    let alertContent = document.createElement("DIV");
    alertContent.innerHTML = winnerInfo;
    alertContent.appendChild(table);
    alert(`<h3>Results for Card-${cardNumber}</h3><h5>Player Name: ${playerName}</h5>`, alertContent);
}

function getPlayerName(cardNumber) {
  try {
    let cookieData = getCookie('urls').split('|');
    for (let player of cookieData) {
      let playerData = player.split(':');
      if (playerData[0] !== '!') {
        let name = playerData[0]
        let cards = playerData[1].split(',');
        if (cards.includes(cardNumber)) {
          return `<span class="label label-success">${name}</span>`;
        }
      }
    }
  }
  catch(err) {
    console.log(`Error trying to get the player name`);
  }
  return `<span class="label label-danger">UNASSIGNED</span>`;
}

function loadDoc(file, callback) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(this);
    }
  };
  xhttp.open("GET", file, true);
  xhttp.send();
}

</script>

</body>
</html>
